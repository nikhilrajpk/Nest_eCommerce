{% extends 'admin_app/admin_base.html' %}
{% load static %}
{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<br><br>
    <div class="container mt-5">
        <h2 class="mb-4">Edit Category</h2>
        <form action="" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
                <label for="category-name" class="form-label">Category Name:</label>
                <input type="text" class="form-control" id="category-name" name="category_name" value="{{category.category_name}}" required>
            </div>


            <div class="mb-3">
                <label for="category-image" class="form-label">Category Image:</label>

                <!-- Image Preview -->
                {% if category.cat_image %}
                    <div class="mb-2">
                        <img src="{{ category.cat_image.url }}" alt="{{ category.category_name }}" width="100" height="100">
                    </div>
                {% endif %}

                <input type="file" class="form-control image-input" id="category-image" name="category_image" accept="image/*">
            </div>

            <!-- Modal for cropping -->
            <div id="cropperModal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">Crop Image</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    </div>
                    <div class="modal-body">
                    <img id="cropperImage" src="" alt="Crop Image Preview" style="max-width: 100%;">
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="cropImage()">Crop</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="available" class="form-label">Available:</label>
                {% if category.is_listed %}
                    <select class="form-select" id="available" name="available" required>
                        <option value="True">Yes</option>
                        <option value="False">No</option>
                    </select>
                {% else %}
                    <select class="form-select" id="available" name="available" required>
                        <option value="False">No</option>
                        <option value="True">Yes</option>
                    </select>
                {% endif %}
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary">Edit Category</button>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let cropper;
    let activeInput;
    
    document.querySelectorAll('.image-input').forEach(input => {
      input.addEventListener('change', function() {
        const file = this.files[0];
        activeInput = this;  // Store reference to the active input
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('cropperImage').src = e.target.result;
            $('#cropperModal').modal('show');
    
            if (cropper) {
              cropper.destroy();
            }
    
            cropper = new Cropper(document.getElementById('cropperImage'), {
              aspectRatio: 1,
              viewMode: 1,
            });
          };
          reader.readAsDataURL(file);
        }
      });
    });
    
    function cropImage() {
      if (cropper && activeInput) {
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(new File([blob], 'cropped_image.png', { type: 'image/png' }));
          activeInput.files = dataTransfer.files;
    
          $('#cropperModal').modal('hide');
        });
      }
    }
    
    </script>
{% endblock content %}